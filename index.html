<!--
Version: 15.0.3 (Duplicate Message Fix)
Date: August 5, 2025
Notes:
- This is the final, stable version of the frontend.
- Includes full authentication, password recovery, and conversation persistence.
- Fixes a bug where the initial welcome message was displayed multiple times on login.
-->
<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Smartlinks Coaching Platform</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700&display=swap" rel="stylesheet">
    <style>
        body { font-family: 'Inter', sans-serif; background-color: #f0f4f8; }
        .spinner { border: 4px solid rgba(0, 0, 0, 0.1); width: 24px; height: 24px; border-radius: 50%; border-left-color: #003F5C; animation: spin 1s ease infinite; }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
    </style>
</head>
<body class="text-gray-800">
    <div class="container mx-auto p-4 md:p-8">
        
        <header class="text-center mb-12">
            <h1 class="text-4xl md:text-5xl font-bold text-[#003F5C] mb-4">Smartlinks Coaching Platform</h1>
            <p class="text-lg text-[#374C80]">Your AI-Powered Coaching Companion</p>
            <p class="text-md text-[#374C80] mt-4">Created by: Heera Ganjikota - ICF PCC</p>
        </header>

        <main>
            <!-- Login View -->
            <section id="login-view" class="max-w-md mx-auto bg-white p-8 rounded-lg shadow-lg hidden">
                <h2 class="text-2xl font-bold text-center text-gray-800 mb-6">Member Login</h2>
                <form id="login-form">
                    <div class="mb-4"><label for="email" class="block text-gray-700 font-semibold mb-2">Email Address</label><input type="email" id="email" class="w-full p-3 rounded-md border border-gray-300 focus:ring-2 focus:ring-[#FFA600] focus:outline-none" required></div>
                    <div class="mb-6"><label for="password" class="block text-gray-700 font-semibold mb-2">Password</label><input type="password" id="password" class="w-full p-3 rounded-md border border-gray-300 focus:ring-2 focus:ring-[#FFA600] focus:outline-none" required></div>
                    <button type="submit" class="w-full bg-[#003F5C] hover:bg-[#374C80] text-white font-bold py-3 px-4 rounded-md transition-colors duration-300">Sign In</button>
                </form>
                <p class="text-center mt-4"><a href="#" id="forgot-password-link" class="text-sm text-blue-600 hover:underline">Forgot Password?</a></p>
                <p id="auth-message" class="text-center mt-4"></p>
            </section>

            <!-- Password Reset View -->
            <section id="reset-password-view" class="max-w-md mx-auto bg-white p-8 rounded-lg shadow-lg hidden">
                <h2 class="text-2xl font-bold text-center text-gray-800 mb-6">Reset Password</h2>
                <form id="reset-password-form">
                    <div class="mb-4"><label for="reset-email" class="block text-gray-700 font-semibold mb-2">Email Address</label><input type="email" id="reset-email" class="w-full p-3 rounded-md border border-gray-300 focus:ring-2 focus:ring-[#FFA600] focus:outline-none" required></div>
                    <button type="submit" class="w-full bg-[#003F5C] hover:bg-[#374C80] text-white font-bold py-3 px-4 rounded-md transition-colors duration-300">Send Reset Link</button>
                </form>
                 <p class="text-center mt-4"><a href="#" id="back-to-login-link" class="text-sm text-blue-600 hover:underline">Back to Login</a></p>
                 <p id="reset-message" class="text-center mt-4"></p>
            </section>

            <!-- Chatbot View -->
            <section id="chatbot-view" class="mb-16 hidden">
                <div class="text-right mb-4"><button id="logout-button" class="bg-red-500 hover:bg-red-600 text-white font-semibold py-2 px-4 rounded-md transition-colors duration-300">Logout</button></div>
                <div class="bg-gradient-to-br from-[#003F5C] to-[#374C80] rounded-lg shadow-xl p-6 md:p-8 text-white">
                    <h3 class="text-3xl font-bold text-center mb-4">Your Coaching Companion</h3>
                    <div class="max-w-2xl mx-auto bg-white/10 rounded-lg p-4">
                        <div id="chat-window" class="h-80 overflow-y-auto pr-2 space-y-4 flex flex-col"></div>
                        <div id="chat-input-container" class="mt-4 flex items-center space-x-2"><input type="text" id="chat-input" class="w-full flex-grow p-3 rounded-md text-gray-800 focus:ring-2 focus:ring-[#FFA600] focus:outline-none" placeholder="Type your message..."><button id="send-button" class="bg-[#FFA600] hover:bg-[#FF764A] text-white font-bold py-3 px-4 rounded-md transition-colors duration-300">Send</button></div>
                        <div id="chat-controls" class="mt-4 flex justify-start items-center text-sm"><button id="new-conversation-button" class="bg-gray-500 hover:bg-gray-600 text-white font-semibold py-2 px-4 rounded-md transition-colors duration-300">New Conversation</button></div>
                    </div>
                </div>
            </section>
        </main>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <script>
        document.addEventListener('DOMContentLoaded', () => {
            
            const SUPABASE_URL = 'https://cthplmtrawzqtgdliebl.supabase.co';
            const SUPABASE_ANON_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImN0aHBsbXRyYXd6cXRnZGxpZWJsIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTM5NzI3NzUsImV4cCI6MjA2OTU0ODc3NX0.uzUHhbWulubUn6LZkeYQZcwLh7yVp1DXsrccP-6WPqA';
            const supabaseClient = supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY);

            // --- UI ELEMENTS ---
            const loginView = document.getElementById('login-view');
            const resetPasswordView = document.getElementById('reset-password-view');
            const chatbotView = document.getElementById('chatbot-view');
            const loginForm = document.getElementById('login-form');
            const resetPasswordForm = document.getElementById('reset-password-form');
            const authMessage = document.getElementById('auth-message');
            const resetMessage = document.getElementById('reset-message');
            const forgotPasswordLink = document.getElementById('forgot-password-link');
            const backToLoginLink = document.getElementById('back-to-login-link');
            const logoutButton = document.getElementById('logout-button');
            const chatWindow = document.getElementById('chat-window');
            const chatInput = document.getElementById('chat-input');
            const sendButton = document.getElementById('send-button');
            const newConversationButton = document.getElementById('new-conversation-button');

            // --- STATE MANAGEMENT ---
            let chatHistory = [];
            let isChatInitialized = false; 
            const INITIAL_COACH_MESSAGE = "Hello! I'm here to offer a confidential space for our conversation. To begin, what feels most important for you to focus on today?";

            // --- AUTHENTICATION & VIEW MANAGEMENT ---
            const showView = (viewToShow) => {
                [loginView, resetPasswordView, chatbotView].forEach(view => view.classList.add('hidden'));
                viewToShow.classList.remove('hidden');
            };
            
            supabaseClient.auth.onAuthStateChange((_event, session) => {
                if (session) {
                    showChatbotView();
                } else {
                    isChatInitialized = false; 
                    showView(loginView);
                }
            });

            loginForm.addEventListener('submit', async (e) => { e.preventDefault(); authMessage.textContent = ''; const { error } = await supabaseClient.auth.signInWithPassword({ email: document.getElementById('email').value, password: document.getElementById('password').value }); if (error) authMessage.textContent = error.message; else loginForm.reset(); });
            logoutButton.addEventListener('click', async () => { await supabaseClient.auth.signOut(); });
            forgotPasswordLink.addEventListener('click', (e) => { e.preventDefault(); showView(resetPasswordView); });
            backToLoginLink.addEventListener('click', (e) => { e.preventDefault(); showView(loginView); });
            resetPasswordForm.addEventListener('submit', async (e) => { e.preventDefault(); resetMessage.textContent = ''; const email = document.getElementById('reset-email').value; const { error } = await supabaseClient.auth.resetPasswordForEmail(email, { redirectTo: window.location.href }); if (error) { resetMessage.textContent = error.message; } else { resetMessage.textContent = 'Success! Please check your email for a password reset link.'; } });

            async function showChatbotView() {
                if (isChatInitialized) return; 
                isChatInitialized = true;
                showView(chatbotView);
                await loadChatHistory();
            }

            // --- CHATBOT LOGIC ---
            const addMessage = (sender, message) => { const msg = document.createElement('div'); msg.className = `w-full flex ${sender === 'user' ? 'justify-end' : 'justify-start'}`; msg.innerHTML = `<div class="max-w-md rounded-lg p-3 ${sender === 'user' ? 'bg-[#003F5C] text-white' : 'bg-white text-gray-800 shadow-sm'}"><p>${message.replace(/\n/g, '<br>')}</p></div>`; chatWindow.appendChild(msg); chatWindow.scrollTop = chatWindow.scrollHeight; };
            const showChatSpinner = () => { if (!document.getElementById('spinner')) { const s = document.createElement('div'); s.id = 'spinner'; s.className = 'w-full flex justify-start'; s.innerHTML = '<div class="max-w-md rounded-lg p-3 bg-white text-gray-800 shadow-sm flex items-center"><div class="spinner"></div></div>'; chatWindow.appendChild(s); chatWindow.scrollTop = chatWindow.scrollHeight; }};
            const hideChatSpinner = () => { const s = document.getElementById('spinner'); if (s) s.remove(); };

            const resetChat = async () => {
                chatHistory = [];
                chatWindow.innerHTML = '';
                addMessage('bot', INITIAL_COACH_MESSAGE);
                try {
                    await supabaseClient.functions.invoke('coaching-proxy', { body: { task: 'clear_history' } });
                } catch (error) { console.error("Failed to clear history in DB:", error); }
            };

            const loadChatHistory = async () => {
                chatWindow.innerHTML = '';
                showChatSpinner();
                try {
                    const { data, error } = await supabaseClient.functions.invoke('coaching-proxy', { body: { task: 'get_history' } });
                    if (error) throw error;
                    chatHistory = data.history || [];
                    if (chatHistory.length === 0) { addMessage('bot', INITIAL_COACH_MESSAGE); } 
                    else { chatHistory.forEach(turn => addMessage(turn.role === 'user' ? 'user' : 'bot', turn.parts[0].text)); }
                } catch (error) { console.error("Failed to load chat history:", error); addMessage('bot', 'Could not load previous conversation.'); } 
                finally { hideChatSpinner(); }
            };

            const getBotResponse = async () => {
                try {
                    const { data, error } = await supabaseClient.functions.invoke('coaching-proxy', { 
                        body: { chatHistory: chatHistory } 
                    });
                    if (error) throw error;
                    hideChatSpinner();
                    addMessage('bot', data.botResponse);
                } catch (error) { console.error("Function call failed:", error); hideChatSpinner(); addMessage('bot', `Sorry, an error occurred: ${error.message}.`); }
            };

            const handleSend = async () => {
                const userText = chatInput.value.trim();
                if (!userText) return;
                addMessage('user', userText);
                chatInput.value = '';
                chatHistory.push({ role: "user", parts: [{ text: userText }] });
                
                sendButton.disabled = true;
                showChatSpinner();
                await getBotResponse();
                sendButton.disabled = false;
                chatInput.focus();
            };
            
            sendButton.addEventListener('click', handleSend);
            chatInput.addEventListener('keydown', (event) => { if (event.key === 'Enter') handleSend(); });
            newConversationButton.addEventListener('click', resetChat);
        });
    </script>
</body>
</html>
